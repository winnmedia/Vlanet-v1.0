name: Deploy to Staging

on:
  push:
    branches: [ develop, staging ]
  pull_request:
    branches: [ main, master ]

env:
  SERVER_HOST: ${{ secrets.STAGING_SERVER_HOST || secrets.SERVER_HOST }}
  SERVER_USER: ${{ secrets.SERVER_USER }}
  PROJECT_PATH: /var/www/vridge-staging

jobs:
  staging-deploy:
    name: Deploy to Staging Environment
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    
    steps:
    - name: ğŸš€ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ”‘ Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
    - name: ğŸŒ Add server to known hosts
      run: |
        ssh-keyscan -H ${{ env.SERVER_HOST }} >> ~/.ssh/known_hosts
    
    - name: ğŸ“¦ Deploy to staging
      run: |
        # ìŠ¤í…Œì´ì§• ë””ë ‰í† ë¦¬ ìƒì„±
        ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "
          sudo mkdir -p ${{ env.PROJECT_PATH }}
          sudo chown ${{ env.SERVER_USER }}:${{ env.SERVER_USER }} ${{ env.PROJECT_PATH }}
        "
        
        # ì½”ë“œ ë™ê¸°í™”
        rsync -avz --exclude='.git' \
          --exclude='node_modules' \
          --exclude='__pycache__' \
          --exclude='.env*' \
          --delete \
          ./ ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }}:${{ env.PROJECT_PATH }}/
    
    - name: ğŸ”§ Configure staging environment
      run: |
        ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "
          cd ${{ env.PROJECT_PATH }} && 
          
          # ìŠ¤í…Œì´ì§•ìš© í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
          if [ ! -f vridge_back/.env ]; then
            cp vridge_back/.env.example vridge_back/.env
            sed -i 's/DEBUG=False/DEBUG=True/' vridge_back/.env
            sed -i 's/your-domain.com/staging.vlanet.net/' vridge_back/.env
          fi
          
          if [ ! -f vridge_front/.env.staging ]; then
            cp vridge_front/.env.example vridge_front/.env.staging
            sed -i 's/production/staging/' vridge_front/.env.staging
          fi
          
          chmod +x scripts/*.sh
        "
    
    - name: ğŸ³ Start staging services
      run: |
        ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "
          cd ${{ env.PROJECT_PATH }} && 
          
          # ë‹¤ë¥¸ í¬íŠ¸ë¡œ ì„œë¹„ìŠ¤ ì‹¤í–‰ (ì¶©ëŒ ë°©ì§€)
          export FRONTEND_PORT=3001
          export BACKEND_PORT=8001
          export POSTGRES_PORT=5433
          export REDIS_PORT=6380
          
          # Docker Compose ì˜¤ë²„ë¼ì´ë“œë¡œ í¬íŠ¸ ë³€ê²½
          cat > docker-compose.override.yml << EOF
services:
  frontend:
    ports:
      - \"127.0.0.1:\${FRONTEND_PORT:-3001}:80\"
  backend:
    ports:
      - \"127.0.0.1:\${BACKEND_PORT:-8001}:8000\"
  postgres:
    ports:
      - \"127.0.0.1:\${POSTGRES_PORT:-5433}:5432\"
  redis:
    ports:
      - \"127.0.0.1:\${REDIS_PORT:-6380}:6379\"
EOF
          
          docker-compose -f docker-compose.gabia.yml up --build -d
        "
    
    - name: ğŸ¥ Staging health check
      run: |
        ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "
          cd ${{ env.PROJECT_PATH }} && 
          sleep 30
          
          if curl -f http://localhost:8001/admin/ > /dev/null 2>&1; then
            echo 'âœ… Staging backend is healthy'
          else
            echo 'âŒ Staging backend health check failed'
          fi
          
          if curl -f http://localhost:3001/ > /dev/null 2>&1; then
            echo 'âœ… Staging frontend is healthy'
          else
            echo 'âŒ Staging frontend health check failed'
          fi
        "

  # PR ë¯¸ë¦¬ë³´ê¸° (ì½”ë©˜íŠ¸ë¡œ ìŠ¤í…Œì´ì§• URL ì œê³µ)
  pr-preview:
    name: PR Preview Comment
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: ğŸ’¬ Comment PR with preview info
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ğŸ” PR ë¯¸ë¦¬ë³´ê¸°
            
            ì´ PRì˜ ë³€ê²½ì‚¬í•­ì„ ë¯¸ë¦¬ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
            
            - **ìŠ¤í…Œì´ì§• ì‚¬ì´íŠ¸**: http://staging.vlanet.net:3001
            - **API ì—”ë“œí¬ì¸íŠ¸**: http://staging.vlanet.net:8001
            - **ì»¤ë°‹**: \`${context.sha.substring(0, 7)}\`
            
            ### í…ŒìŠ¤íŠ¸ ë°©ë²•
            1. ìœ„ ìŠ¤í…Œì´ì§• URLì—ì„œ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
            2. ë¬¸ì œê°€ ì—†ìœ¼ë©´ ì´ PRì„ ìŠ¹ì¸í•´ì£¼ì„¸ìš”
            3. ë©”ì¸ ë¸Œëœì¹˜ ë¨¸ì§€ ì‹œ ìë™ìœ¼ë¡œ í”„ë¡œë•ì…˜ ë°°í¬ë©ë‹ˆë‹¤
            
            ---
            ğŸ¤– *ì´ ì½”ë©˜íŠ¸ëŠ” GitHub Actionsì— ì˜í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤*`
          })
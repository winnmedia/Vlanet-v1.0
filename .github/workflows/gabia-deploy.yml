name: Deploy to Gabia Hosting

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸš€ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: vridge_front/package-lock.json
        
    - name: ðŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: ðŸ—ï¸ Build React Frontend
      run: |
        cd vridge_front
        npm ci
        npm run build
        echo "âœ… Frontend build completed"
        
    - name: ðŸ“¦ Prepare Django Backend
      run: |
        cd vridge_back
        pip install -r requirements.txt
        echo "âœ… Backend dependencies installed"
        
    - name: ðŸš€ Deploy to Gabia via SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.GABIA_HOST }}
        username: ${{ secrets.GABIA_USERNAME }}
        password: ${{ secrets.GABIA_PASSWORD }}
        port: 22
        script: |
          echo "ðŸ”§ Starting deployment process..."
          
          # ë°±ì—… ìƒì„±
          if [ -d ~/videoplanet ]; then
            echo "ðŸ“¦ Creating backup..."
            cp -r ~/videoplanet ~/videoplanet_backup_$(date +%Y%m%d_%H%M%S)
          fi
          
          # í•„ìš”í•œ ë””ë ‰í† ë¦¬ ìƒì„±
          echo "ðŸ“ Creating directories..."
          mkdir -p ~/videoplanet
          mkdir -p ~/htdocs 2>/dev/null || mkdir -p ~/public_html 2>/dev/null || mkdir -p ~/www
          
          # ê¸°ì¡´ íŒŒì¼ ì •ë¦¬
          echo "ðŸ§¹ Cleaning old files..."
          rm -rf ~/videoplanet/* 2>/dev/null || true
          
          echo "âœ… Server preparation completed"
          
    - name: ðŸ“¤ Upload Backend Files
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.GABIA_HOST }}
        username: ${{ secrets.GABIA_USERNAME }}
        password: ${{ secrets.GABIA_PASSWORD }}
        port: 22
        source: "vridge_back/*"
        target: "/home/${{ secrets.GABIA_USERNAME }}/videoplanet/"
        strip_components: 1
        
    - name: ðŸŒ Upload Frontend Files
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.GABIA_HOST }}
        username: ${{ secrets.GABIA_USERNAME }}
        password: ${{ secrets.GABIA_PASSWORD }}
        port: 22
        source: "vridge_front/build/*"
        target: "/home/${{ secrets.GABIA_USERNAME }}/htdocs/"
        strip_components: 2
        
    - name: âš™ï¸ Configure Gabia Server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.GABIA_HOST }}
        username: ${{ secrets.GABIA_USERNAME }}
        password: ${{ secrets.GABIA_PASSWORD }}
        port: 22
        script: |
          cd ~/videoplanet
          echo "ðŸ”§ Configuring Django application..."
          
          # Python íŒ¨í‚¤ì§€ ì„¤ì¹˜
          echo "ðŸ“¦ Installing Python packages..."
          pip install -r requirements.txt --user
          
          # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
          echo "ðŸ” Setting up environment variables..."
          cat > .env << EOF
          SECRET_KEY=${{ secrets.DJANGO_SECRET_KEY }}
          DEBUG=False
          ALLOWED_HOSTS=${{ secrets.GABIA_DOMAIN }},www.${{ secrets.GABIA_DOMAIN }}
          
          # ë°ì´í„°ë² ì´ìŠ¤
          DB_NAME=${{ secrets.DB_NAME }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_HOST=localhost
          DB_PORT=3306
          
          # Twelve Labs API
          TWELVE_LABS_API_KEY=${{ secrets.TWELVE_LABS_API_KEY }}
          TWELVE_LABS_INDEX_ID=${{ secrets.TWELVE_LABS_INDEX_ID }}
          
          # íŒŒì¼ ê²½ë¡œ ì„¤ì •
          STATIC_ROOT=/home/${{ secrets.GABIA_USERNAME }}/htdocs/static/
          MEDIA_ROOT=/home/${{ secrets.GABIA_USERNAME }}/htdocs/media/
          EOF
          
          # Django ë§ˆì´ê·¸ë ˆì´ì…˜ ë° ì •ì  íŒŒì¼ ìˆ˜ì§‘
          echo "ðŸ—ƒï¸ Running Django migrations..."
          python manage.py migrate --settings=config.settings.production
          
          echo "ðŸ“ Collecting static files..."
          python manage.py collectstatic --noinput --settings=config.settings.production
          
          # ê¶Œí•œ ì„¤ì •
          echo "ðŸ”’ Setting file permissions..."
          chmod 755 ~/videoplanet
          chmod 644 ~/videoplanet/*.py 2>/dev/null || true
          chmod 600 ~/.env
          
          echo "âœ… Django configuration completed"
          
    - name: ðŸŒ Setup Web Server Configuration  
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.GABIA_HOST }}
        username: ${{ secrets.GABIA_USERNAME }}
        password: ${{ secrets.GABIA_PASSWORD }}
        port: 22
        script: |
          # ì›¹ ë£¨íŠ¸ ë””ë ‰í† ë¦¬ ì°¾ê¸°
          if [ -d ~/htdocs ]; then
            WEBROOT=~/htdocs
          elif [ -d ~/public_html ]; then
            WEBROOT=~/public_html
          elif [ -d ~/www ]; then
            WEBROOT=~/www
          else
            echo "âŒ Web root directory not found"
            exit 1
          fi
          
          echo "ðŸŒ Setting up web server in $WEBROOT..."
          cd $WEBROOT
          
          # .htaccess íŒŒì¼ ìƒì„±
          echo "ðŸ“ Creating .htaccess file..."
          cat > .htaccess << 'EOF'
          RewriteEngine On
          
          # API ìš”ì²­ì„ Djangoë¡œ ì „ë‹¬
          RewriteRule ^api/(.*)$ /cgi-bin/videoplanet.cgi/$1 [QSA,L]
          RewriteRule ^admin/(.*)$ /cgi-bin/videoplanet.cgi/admin/$1 [QSA,L]
          RewriteRule ^ws/(.*)$ /cgi-bin/videoplanet.cgi/ws/$1 [QSA,L]
          
          # React Router ì§€ì›
          RewriteCond %{REQUEST_FILENAME} !-f
          RewriteCond %{REQUEST_FILENAME} !-d
          RewriteRule . /index.html [L]
          
          # ë³´ì•ˆ í—¤ë”
          Header always set X-Frame-Options "SAMEORIGIN"
          Header always set X-XSS-Protection "1; mode=block"
          Header always set X-Content-Type-Options "nosniff"
          
          # Gzip ì••ì¶•
          <IfModule mod_deflate.c>
              AddOutputFilterByType DEFLATE text/css
              AddOutputFilterByType DEFLATE application/javascript
              AddOutputFilterByType DEFLATE application/json
          </IfModule>
          EOF
          
          # CGI ìŠ¤í¬ë¦½íŠ¸ ë””ë ‰í† ë¦¬ ìƒì„±
          echo "ðŸ”§ Setting up CGI script..."
          mkdir -p $WEBROOT/cgi-bin
          cd $WEBROOT/cgi-bin
          
          # Django CGI ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
          cat > videoplanet.cgi << EOF
          #!/usr/bin/python3
          
          import sys
          import os
          
          # í”„ë¡œì íŠ¸ ê²½ë¡œ ì„¤ì •
          sys.path.insert(0, '/home/${{ secrets.GABIA_USERNAME }}/videoplanet')
          os.environ['DJANGO_SETTINGS_MODULE'] = 'config.settings.production'
          
          # Django WSGI ì• í”Œë¦¬ì¼€ì´ì…˜
          from django.core.wsgi import get_wsgi_application
          application = get_wsgi_application()
          
          # CGI í•¸ë“¤ëŸ¬
          from wsgiref.handlers import CGIHandler
          CGIHandler().run(application)
          EOF
          
          # ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
          chmod +x videoplanet.cgi
          
          echo "âœ… Web server configuration completed"
          
    - name: ðŸ§ª Test Deployment
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.GABIA_HOST }}
        username: ${{ secrets.GABIA_USERNAME }}
        password: ${{ secrets.GABIA_PASSWORD }}
        port: 22
        script: |
          echo "ðŸ§ª Testing deployment..."
          
          # Django ì•± í…ŒìŠ¤íŠ¸
          cd ~/videoplanet
          python manage.py check --settings=config.settings.production
          
          # ì›¹ ë£¨íŠ¸ íŒŒì¼ í™•ì¸
          if [ -d ~/htdocs ]; then
            WEBROOT=~/htdocs
          elif [ -d ~/public_html ]; then
            WEBROOT=~/public_html  
          elif [ -d ~/www ]; then
            WEBROOT=~/www
          fi
          
          if [ -f "$WEBROOT/index.html" ]; then
            echo "âœ… Frontend files deployed successfully"
          else
            echo "âŒ Frontend files not found"
          fi
          
          if [ -f "$WEBROOT/cgi-bin/videoplanet.cgi" ]; then
            echo "âœ… CGI script deployed successfully"
          else
            echo "âŒ CGI script not found"
          fi
          
          echo "ðŸŽ‰ Deployment test completed"
          
    - name: ðŸ“Š Deployment Summary
      run: |
        echo "## ðŸŽ‰ Deployment Completed Successfully!"
        echo ""
        echo "### ðŸ“‹ Deployment Details:"
        echo "- **Website**: https://${{ secrets.GABIA_DOMAIN }}"
        echo "- **Admin Panel**: https://${{ secrets.GABIA_DOMAIN }}/admin/"
        echo "- **Commit**: ${{ github.sha }}"
        echo "- **Branch**: ${{ github.ref_name }}"
        echo "- **Actor**: ${{ github.actor }}"
        echo "- **Timestamp**: $(date)"
        echo ""
        echo "### ðŸ”— Useful Links:"
        echo "- [Gabia Hosting Management](https://my.gabia.com)"
        echo "- [Twelve Labs Dashboard](https://playground.twelvelabs.io)"
        echo ""
        echo "### ðŸ“ Next Steps:"
        echo "1. Test website functionality"
        echo "2. Create Django superuser account"
        echo "3. Upload test video for AI analysis"
name: Deploy to Gabia Hosting

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

env:
  GABIA_HOST: ${{ secrets.GABIA_HOST }}
  GABIA_USERNAME: ${{ secrets.GABIA_USERNAME }}
  GABIA_DOMAIN: ${{ secrets.GABIA_DOMAIN }}

jobs:
  deploy:
    name: Deploy to Gabia Hosting
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸš€ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: vridge_front/package-lock.json
        
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: ğŸ—ï¸ Build Frontend
      run: |
        cd vridge_front
        npm ci
        npm run build
        
    - name: ğŸ“¦ Prepare Backend
      run: |
        cd vridge_back
        pip install -r requirements.txt
    
    - name: ğŸ›‘ Stop services (if full restart)
      if: github.event.inputs.deploy_type == 'full-restart'
      run: |
        ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "
          cd ${{ env.PROJECT_PATH }} && 
          docker-compose down
        "
    
    - name: ğŸ“¦ Deploy code to server
      run: |
        # ì„œë²„ì— ì½”ë“œ ë™ê¸°í™”
        rsync -avz --exclude='.git' \
          --exclude='node_modules' \
          --exclude='__pycache__' \
          --exclude='.env*' \
          --delete \
          ./ ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }}:${{ env.PROJECT_PATH }}/
    
    - name: ğŸ”§ Set execute permissions
      run: |
        ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "
          cd ${{ env.PROJECT_PATH }} && 
          chmod +x scripts/*.sh
        "
    
    - name: ğŸ“ Create deployment info
      run: |
        ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "
          cd ${{ env.PROJECT_PATH }} && 
          echo 'Deployment Info:' > deployment-info.txt &&
          echo 'Date: $(date)' >> deployment-info.txt &&
          echo 'Commit: ${{ github.sha }}' >> deployment-info.txt &&
          echo 'Branch: ${{ github.ref_name }}' >> deployment-info.txt &&
          echo 'Actor: ${{ github.actor }}' >> deployment-info.txt
        "
    
    - name: ğŸ³ Build and start services
      run: |
        ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "
          cd ${{ env.PROJECT_PATH }} && 
          
          # Docker ì´ë¯¸ì§€ ë¹Œë“œ (ìºì‹œ í™œìš©)
          docker-compose -f docker-compose.gabia.yml build --pull
          
          # ì„œë¹„ìŠ¤ ì‹œì‘
          docker-compose -f docker-compose.gabia.yml up -d
          
          # í—¬ìŠ¤ì²´í¬ ëŒ€ê¸°
          echo 'â³ Waiting for services to be ready...'
          sleep 30
        "
    
    - name: ğŸ¥ Health check
      run: |
        ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "
          cd ${{ env.PROJECT_PATH }} && 
          
          # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
          docker-compose -f docker-compose.gabia.yml ps
          
          # ë°±ì—”ë“œ í—¬ìŠ¤ì²´í¬
          if curl -f http://localhost:8000/admin/ > /dev/null 2>&1; then
            echo 'âœ… Backend is healthy'
          else
            echo 'âŒ Backend health check failed'
            exit 1
          fi
          
          # í”„ë¡ íŠ¸ì—”ë“œ í—¬ìŠ¤ì²´í¬  
          if curl -f http://localhost:3000/ > /dev/null 2>&1; then
            echo 'âœ… Frontend is healthy'
          else
            echo 'âŒ Frontend health check failed'
            exit 1
          fi
        "
    
    - name: ğŸ”„ Reload Nginx
      run: |
        ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "
          sudo nginx -t && sudo systemctl reload nginx
        "
    
    - name: ğŸ“Š Post-deployment status
      run: |
        ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "
          cd ${{ env.PROJECT_PATH }} && 
          echo 'ğŸ‰ Deployment completed successfully!' &&
          echo 'ğŸ“Š Service Status:' &&
          docker-compose -f docker-compose.gabia.yml ps --format 'table {{.Name}}\t{{.Status}}\t{{.Ports}}' &&
          echo '' &&
          echo 'ğŸ’¾ Disk Usage:' &&
          df -h / | tail -1 &&
          echo '' &&
          echo 'ğŸ§  Memory Usage:' &&
          free -h | grep Mem
        "
    
    - name: ğŸ§¹ Cleanup old Docker images
      run: |
        ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "
          # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” Docker ì´ë¯¸ì§€ ì •ë¦¬
          docker image prune -f
          docker container prune -f
        "
    
    - name: ğŸ“§ Notify deployment result
      if: always()
      run: |
        STATUS="${{ job.status }}"
        COMMIT_MSG="${{ github.event.head_commit.message }}"
        
        ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "
          echo 'Deployment $STATUS at $(date)' >> ${{ env.PROJECT_PATH }}/deployment.log &&
          echo 'Commit: ${{ github.sha }}' >> ${{ env.PROJECT_PATH }}/deployment.log &&
          echo 'Message: $COMMIT_MSG' >> ${{ env.PROJECT_PATH }}/deployment.log &&
          echo '---' >> ${{ env.PROJECT_PATH }}/deployment.log
        "

  # ë¡¤ë°± ì‘ì—… (ì„ íƒì‚¬í•­)
  rollback:
    name: Rollback deployment
    runs-on: ubuntu-latest
    if: github.event.inputs.deploy_type == 'rollback'
    
    steps:
    - name: ğŸ”‘ Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
    - name: ğŸŒ Add server to known hosts
      run: |
        ssh-keyscan -H ${{ env.SERVER_HOST }} >> ~/.ssh/known_hosts
    
    - name: ğŸ”„ Rollback to previous version
      run: |
        ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "
          cd ${{ env.PROJECT_PATH }} && 
          
          # Gitì„ ì‚¬ìš©í•œ ë¡¤ë°±
          git reset --hard HEAD~1
          
          # ì„œë¹„ìŠ¤ ì¬ì‹œì‘
          docker-compose -f docker-compose.gabia.yml down
          docker-compose -f docker-compose.gabia.yml up --build -d
          
          echo 'ğŸ”„ Rollback completed'
        "